{% extends 'components/base/base.html' %}
{% load static %}

{% block title %}Módulo de Clasificación por Especies | EcoGuard{% endblock %}
{% block meta_description %}Módulo interactivo para clasificar especies basado en su tipo, ubicación y estado de conservación. Incluye gráficos y tablas dinámicas.{% endblock %}
{% block meta_keywords %}especies, conservación, gráficos, interactivo, biodiversidad{% endblock %}

{% block custom_styles %}
<style>
    input[type="range"] {
        accent-color: #3b82f6;
    }

    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        padding: 20px;
        box-sizing: border-box;
    }
    
    #populationChart {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        max-width: 500px;
        max-height: 500px;
        margin: 0 auto;
    }

    /* Flex and responsive layout adjustments */
    .chart-left {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 70%;
        height: 100%;
        padding: 20px;
        box-sizing: border-box;
    }

    .legend-right {
        width: 30%;
        display: flex;
        flex-direction: column;
        padding-left: 20px;
    }

    .container-fluid {
        max-width: 100%;
        padding: 0 10px;
    }

    @media (max-width: 768px) {
        .chart-container {
            flex-direction: column;
            align-items: center;
        }

        .chart-left, .legend-right {
            width: 100%;
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<body class="bg-gray-100">
    <header class="bg-white shadow">
        <div class="container mx-auto p-4">
            <h1 class="text-3xl font-bold text-blue-700">Módulo de Clasificación por Especies</h1>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Filtro de Especie -->
            <section class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Filtros de Búsqueda</h2>
                <div class="mb-4">
                    <label for="speciesType" class="block font-medium text-gray-700">Tipo de Especie</label>
                    <select id="speciesType" class="w-full mt-2 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona un tipo...</option>
                        {% for species in species_types %}
                            <option value="{{ species }}">{{ species }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label for="locationFilter" class="block font-medium text-gray-700">Ubicación (País)</label>
                    <select id="locationFilter" class="w-full mt-2 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona un país...</option>
                        {% for species in locations %}
                            <option value="{{ species }}">{{ species }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filtro de Estado de Conservación -->
                <div class="mb-4">
                    <label for="conservationStatus" class="block font-medium text-gray-700">Estado de Conservación</label>
                    <select id="conservationStatus" class="w-full mt-2 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona un estado...</option>
                        {% for conservation_name in conservation_names %}
                            <option value="{{ conservation_name }}">{{ conservation_name }}</option>
                        {% endfor %}
                    </select>                    
                </div>

                <div class="mb-4">
                    <label for="populationRange" class="block font-medium text-gray-700">Intervalo de Población</label>
                    <input type="range" id="populationRange" min="0" max="1000" value="1000" class="w-full mt-2">
                    <div class="flex justify-between text-sm text-gray-600 mt-1">
                        <span>0</span>
                        <span id="populationValue">1000</span>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button id="applyFilters" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:ring-2 focus:ring-blue-400">
                        Aplicar Filtros
                    </button>
                    <button id="resetFilters" class="bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-gray-500 focus:ring-2 focus:ring-gray-300">
                        Restablecer
                    </button>
                </div>
            </section>

            <!-- Gráfico de Población -->
            <section class="md:col-span-2 bg-white p-6 rounded-lg shadow flex justify-center items-center" style="height: 500px; padding: 20px;">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 text-center w-full">Distribución de Población por Tipo de Especie</h2>
                <div class="chart-container flex-center">
                    <div id="populationChart" class="chart-left responsive-svg rounded-md">
                        <!-- Gráfico de Población aquí -->
                    </div>
                </div>
            </section>
        </div>

        <!-- Additional Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <div class="bg-white p-6 rounded-lg shadow flex justify-center items-center" style="height: 450px;">
                <h2 class="text-lg font-semibold text-center text-gray-800 mb-4">Media de Población por Tipo de Especie</h2>
                <div id="meanPopulationChart" class="responsive-svg rounded-md flex justify-center items-center">
                    <span class="text-gray-400">Gráfico de Barras</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow flex justify-center items-center" style="height: 450px;">
                <h2 class="text-lg font-semibold text-center text-gray-800 mb-4">Amenazas Comunes (Nube de Palabras)</h2>
                <div id="wordCloud" class="responsive-svg rounded-md flex justify-center items-center">
                    <span class="text-gray-400">Nube de Palabras</span>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 mt-8">
        <p class="text-center">Desarrollado para análisis de biodiversidad.</p>
    </footer>
{% endblock %}

{% block custom_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const initialData = {{ filtered_data|safe }};  // Datos iniciales de Django

        function generatePopulationChart(data) {
            d3.select("#populationChart").html("");
            const color = d3.scaleOrdinal(d3.schemeCategory10);
            const width = 400;
            const height = 400;
            const radius = Math.min(width, height) / 2 - 10;

            const svg = d3.select('#populationChart')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`)
                .append('g')
                .attr('transform', `translate(${width / 2}, ${height / 2})`);

            const pie = d3.pie().value(d => d['Estimated Population']);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);

            const pieData = pie(data);

            svg.selectAll('path')
                .data(pieData)
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data['Type']))
                .attr('stroke', 'white')
                .attr('stroke-width', 2);
        }

        // Inicializar el gráfico con los datos iniciales del servidor
        generatePopulationChart(initialData);

        // Función para obtener los datos filtrados
        function fetchFilteredData() {
            const speciesType = document.getElementById('speciesType').value;
            const location = document.getElementById('locationFilter').value;
            const conservationStatus = document.getElementById('conservationStatus').value;
            const populationRange = document.getElementById('populationRange').value;

            const url = `/filter-species/?species_type=${speciesType}&location=${location}&conservation_status=${conservationStatus}&min_population=0&max_population=${populationRange}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log("Datos filtrados recibidos:", data);
                    generatePopulationChart(data);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        document.getElementById('applyFilters').addEventListener('click', fetchFilteredData);
        document.getElementById('resetFilters').addEventListener('click', () => location.reload());
    });
</script>
{% endblock %}
