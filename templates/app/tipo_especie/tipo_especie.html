{% extends 'components/base/base.html' %}
{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Módulo interactivo para clasificar especies basado en su tipo, ubicación y estado de conservación. Incluye gráficos y tablas dinámicas.">
    <meta name="keywords" content="especies, conservación, gráficos, interactivo, biodiversidad">
    <title>Módulo de Clasificación por Especies</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud/build/d3.layout.cloud.js"></script>

    <style>
        /* Estilos personalizados aquí */
    </style>
</head>

<body class="bg-gray-100">
    <header class="bg-white shadow">
        <div class="container mx-auto p-4">
            <h1 class="text-3xl font-bold text-blue-700">Módulo de Clasificación por Especies</h1>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Filtro de Especie -->
            <section class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Filtros de Búsqueda</h2>
                <div class="mb-4">
                    <label for="speciesType" class="block font-medium text-gray-700">Tipo de Especie</label>
                    <select id="speciesType" class="w-full mt-2 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona un tipo...</option>
                        {% for species in species_types %}
                            <option value="{{ species }}">{{ species }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label for="locationFilter" class="block font-medium text-gray-700">Ubicación (País)</label>
                    <select id="locationFilter" class="w-full mt-2 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona un país...</option>
                        {% for species in locations %}
                            <option value="{{ species }}">{{ species }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filtro de Estado de Conservación -->
                <div class="mb-4">
                    <label for="conservationStatus" class="block font-medium text-gray-700">Estado de Conservación</label>
                    <select id="conservationStatus" class="w-full mt-2 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona un estado...</option>
                        {% for conservation_name in conservation_names %}
                            <option value="{{ conservation_name }}">{{ conservation_name }}</option>
                        {% endfor %}
                    </select>                    
                </div>

                <div class="mb-4">
                    <label for="populationRange" class="block font-medium text-gray-700">Intervalo de Población</label>
                    <input type="range" id="populationRange" min="0" max="1000" value="1000" class="w-full mt-2">
                    <div class="flex justify-between text-sm text-gray-600 mt-1">
                        <span>0</span>
                        <span id="populationValue">1000</span>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button id="applyFilters" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:ring-2 focus:ring-blue-400">
                        Aplicar Filtros
                    </button>
                    <button id="resetFilters" class="bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-gray-500 focus:ring-2 focus:ring-gray-300">
                        Restablecer
                    </button>
                </div>
            </section>

            <!-- Gráfico de Población -->
            <section class="md:col-span-2 bg-white p-6 rounded-lg shadow flex justify-center items-center" style="height: 500px; padding: 20px;">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 text-center w-full">Distribución de Población por Tipo de Especie</h2>
                <div class="chart-container flex-center">
                    <div id="populationChart" class="chart-left responsive-svg rounded-md" style="height: 100%; width: 100%; max-width: 700px; padding: 20px; margin: 0 auto;">
                        <span class="text-gray-400">Gráfico de Población</span>
                    </div>
                </div>
            </section>
        </div>

        <!-- Additional Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <div class="bg-white p-6 rounded-lg shadow flex justify-center items-center" style="height: 450px;">
                <h2 class="text-lg font-semibold text-center text-gray-800 mb-4">Media de Población por Tipo de Especie</h2>
                <div id="meanPopulationChart" class="responsive-svg rounded-md flex justify-center items-center">
                    <span class="text-gray-400">Gráfico de Barras</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow flex justify-center items-center" style="height: 450px;">
                <h2 class="text-lg font-semibold text-center text-gray-800 mb-4">Amenazas Comunes (Nube de Palabras)</h2>
                <div id="wordCloud" class="responsive-svg rounded-md flex justify-center items-center">
                    <span class="text-gray-400">Nube de Palabras</span>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 mt-8">
        <p class="text-center">Desarrollado para análisis de biodiversidad.</p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Función para obtener los datos del servidor
            function fetchFilteredData() {
                const speciesType = document.getElementById('speciesType').value;
                const location = document.getElementById('locationFilter').value;
                const conservationStatus = document.getElementById('conservationStatus').value;
                const populationRange = document.getElementById('populationRange').value;
    
                const url = `/filter-species/?species_type=${speciesType}&location=${location}&conservation_status=${conservationStatus}&min_population=0&max_population=${populationRange}`;
    
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Llenar los select con los datos obtenidos
                        fillSpeciesTypeSelect(data);
                        fillLocationSelect(data);
                        fillConservationStatusSelect(data);
    
                        // Generar las gráficas
                        generatePopulationChart(data);
                        generateMeanPopulationChart(data);  // Llamada para generar el gráfico de barras
                        generateWordCloud(data);            // Llamada para generar la nube de palabras
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }
    
            // Función para generar el gráfico de población (Circular)
            function generatePopulationChart(data) {
                const color = d3.scaleOrdinal(d3.schemeCategory10);
                const populationChart = d3.select('#populationChart')
                    .append('svg')
                    .attr('width', '100%')
                    .attr('height', '100%')
                    .append('g')
                    .attr('transform', 'translate(150,150)');
    
                const pie = d3.pie().value(d => d['Estimated Population']);
                const arc = d3.arc().innerRadius(0).outerRadius(100);
    
                const pieChartData = pie(data.filter(d => d['Estimated Population'] !== "Desconocido"));
    
                populationChart.selectAll('path')
                    .data(pieChartData)
                    .enter().append('path')
                    .attr('d', arc)
                    .attr('fill', d => color(d.data['Type']))
                    .attr('stroke', 'white')
                    .attr('stroke-width', 2);
            }
    
            // Función para generar el gráfico de barras: Media de Población por Tipo de Especie
            function generateMeanPopulationChart(data) {
                const speciesPopulation = d3.nest()
                    .key(d => d['Type'])
                    .rollup(function(leaves) {
                        return d3.mean(leaves, d => d['Estimated Population']);
                    })
                    .entries(data.filter(d => d['Estimated Population'] !== "Desconocido"));
    
                const margin = { top: 20, right: 30, bottom: 40, left: 40 };
                const width = 400 - margin.left - margin.right;
                const height = 300 - margin.top - margin.bottom;
    
                const svg = d3.select("#meanPopulationChart")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
                const x = d3.scaleBand()
                    .domain(speciesPopulation.map(d => d.key))
                    .range([0, width])
                    .padding(0.1);
    
                const y = d3.scaleLinear()
                    .domain([0, d3.max(speciesPopulation, d => d.value)]).nice()
                    .range([height, 0]);
    
                svg.append("g")
                    .selectAll(".bar")
                    .data(speciesPopulation)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.key))
                    .attr("y", d => y(d.value))
                    .attr("width", x.bandwidth())
                    .attr("height", d => height - y(d.value))
                    .attr("fill", "steelblue");
    
                svg.append("g")
                    .attr("class", "x-axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));
    
                svg.append("g")
                    .attr("class", "y-axis")
                    .call(d3.axisLeft(y));
    
                svg.selectAll(".x-axis text")
                    .style("text-anchor", "middle")
                    .style("font-size", "12px");
    
                svg.selectAll(".y-axis text")
                    .style("font-size", "12px");
    
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", -10)
                    .style("text-anchor", "middle")
                    .style("font-size", "16px")
                    .text("Media de Población por Tipo de Especie");
            }
    
            // Función para generar la nube de palabras: Amenazas Comunes
            function generateWordCloud(data) {
                const threats = data.flatMap(d => d['Threats'].split(',').map(threat => threat.trim()));
                const threatCounts = d3.nest()
                    .key(d => d)
                    .rollup(leaves => leaves.length)
                    .entries(threats);
    
                const wordCloudLayout = d3.layout.cloud()
                    .size([400, 300])
                    .words(threatCounts.map(d => ({ text: d.key, size: d.value * 10 })))
                    .padding(5)
                    .rotate(0)
                    .font("Arial")
                    .fontSize(d => d.size)
                    .on("end", drawWordCloud);
    
                wordCloudLayout.start();
    
                function drawWordCloud(words) {
                    const cloud = d3.select("#wordCloud")
                        .append("svg")
                        .attr("width", 400)
                        .attr("height", 300)
                        .append("g")
                        .attr("transform", "translate(200,150)");
    
                    cloud.selectAll("text")
                        .data(words)
                        .enter().append("text")
                        .attr("text-anchor", "middle")
                        .attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")")
                        .style("font-size", d => d.size + "px")
                        .style("font-family", "Arial")
                        .style("fill", (d, i) => d3.schemeCategory10[i % 10])
                        .text(d => d.text);
                }
            }
    
            // Cargar los filtros cuando cambian
            document.getElementById('speciesType').addEventListener('change', fetchFilteredData);
            document.getElementById('locationFilter').addEventListener('change', fetchFilteredData);
            document.getElementById('conservationStatus').addEventListener('change', fetchFilteredData);
            document.getElementById('populationRange').addEventListener('input', function (e) {
                document.getElementById('populationValue').textContent = e.target.value;
                fetchFilteredData();
            });
    
            // Cargar los datos iniciales
            fetchFilteredData();
        });
    </script>
    

</html>
{% endblock %}
