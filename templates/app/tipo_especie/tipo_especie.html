{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo de Clasificación por Tipo de Especie</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud/build/d3.layout.cloud.js"></script>
    <style>
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .filter-container, .species-list {
            flex: 1;
            padding: 10px;
            background: #f7f7f7;
            border-radius: 8px;
        }

        .population-chart, .bar-chart, .word-cloud {
            flex: 2;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .species-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        .data-table {
            margin-top: 20px;
        }
    </style>
</head>

<body class="bg-gray-200">

    <div class="container mx-auto px-4">
        <h1 class="text-2xl font-bold mt-6">Módulo de Clasificación por Tipo de Especie</h1>
        <p class="text-gray-700">Selecciona el tipo de especie, una ubicación, y explora el análisis detallado.</p>

        <div class="chart-container">
            <!-- Population Distribution Chart -->
            <div class="population-chart" id="populationChart">
                <h2 class="text-lg font-semibold">Distribución de Población por Tipo de Especie</h2>
            </div>

            <!-- Filter and Species List Section -->
            <div class="filter-container">
                <h2 class="text-lg font-semibold">Filtros de Búsqueda</h2>

                <!-- Tipo de Especie -->
                <label for="speciesType" class="block font-medium text-gray-700">Tipo de Especie</label>
                <select id="speciesType" class="w-full mt-2 p-2 border border-gray-300 rounded-md">
                    <option value="">Selecciona un tipo...</option>
                </select>

                <!-- Ubicación -->
                <label for="locationFilter" class="block font-medium text-gray-700 mt-4">Ubicación</label>
                <select id="locationFilter" class="w-full mt-2 p-2 border border-gray-300 rounded-md" disabled>
                    <option value="">Selecciona un país...</option>
                </select>

                <div class="mt-4 species-list" id="speciesList">
                    <h2 class="text-lg font-semibold">Lista de Especies</h2>
                </div>
            </div>
        </div>

        <!-- Additional Graphs -->
        <div class="chart-container mt-6">
            <!-- Bar Chart for Mean Population -->
            <div class="bar-chart" id="meanPopulationChart">
                <h2 class="text-lg font-semibold">Media de Población por Tipo de Especie</h2>
            </div>

            <!-- Word Cloud -->
            <div class="word-cloud" id="wordCloud">
                <h2 class="text-lg font-semibold">Amenazas Comunes (Nube de Palabras)</h2>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-table" id="dataTable">
            <h2 class="text-lg font-semibold mt-6">Resumen Completo de Especies</h2>
            <table id="speciesTable" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Ubicación</th>
                        <th>Población</th>
                        <th>Amenazas</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // Sample data extracted from your CSV file
        const speciesData = [
            { type: "Plant (Tree)", name: "Baishan fir", location: "China", population: 5, threats: "Agriculture, fire" },
            { type: "Insect", name: "Actinote zikani", location: "Brazil", population: "Unknown", threats: "Habitat loss" },
            { type: "Reptile", name: "Leaf scaled sea-snake", location: "Timor Sea", population: "Unknown", threats: "Coral degradation" },
            { type: "Insect", name: "Amani flatwing", location: "Tanzania", population: 500, threats: "Pollution" },
            { type: "Insect", name: "Anisolabis seychellensis", location: "Seychelles", population: "Unknown", threats: "Climate change" }
        ];

        // Populate Select Options
        const speciesTypeSelect = document.getElementById("speciesType");
        const locationFilter = document.getElementById("locationFilter");
        const speciesTypes = [...new Set(speciesData.map(d => d.type))];

        speciesTypes.forEach(type => {
            const option = document.createElement("option");
            option.value = type;
            option.textContent = type;
            speciesTypeSelect.appendChild(option);
        });

        // Update location filter based on selected type
        speciesTypeSelect.addEventListener("change", function () {
            const selectedType = this.value;
            const locations = [...new Set(speciesData.filter(d => d.type === selectedType).map(d => d.location))];

            locationFilter.innerHTML = '<option value="">Selecciona un país...</option>';
            locations.forEach(location => {
                const option = document.createElement("option");
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });

            locationFilter.disabled = locations.length === 0;
        });

        // Render Population Distribution Chart
        function renderChart(data) {
            const width = 400;
            const height = 400;
            const radius = Math.min(width, height) / 2;

            const svg = d3.select("#populationChart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            const color = d3.scaleOrdinal(d3.schemeCategory10);

            const pie = d3.pie().value(d => d.population === "Unknown" ? 0 : d.population);
            const path = d3.arc()
                .outerRadius(radius - 10)
                .innerRadius(0);

            const arc = svg.selectAll(".arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");

            arc.append("path")
                .attr("d", path)
                .attr("fill", d => color(d.data.type));

            arc.append("text")
                .attr("transform", d => `translate(${path.centroid(d)})`)
                .attr("dy", "0.35em")
                .text(d => d.data.type);
        }

        renderChart(speciesData);

        // Render Word Cloud
        function renderWordCloud(data) {
            const words = data.reduce((acc, curr) => acc.concat(curr.threats.split(", ")), []);

            const wordFreq = d3.rollup(
                words,
                v => v.length,
                d => d
            );

            const layout = d3.layout.cloud()
                .size([400, 400])
                .words([...wordFreq.entries()].map(([key, value]) => ({ text: key, size: value * 10 })))
                .padding(5)
                .rotate(() => (~~(Math.random() * 2) * 90))
                .fontSize(d => d.size)
                .on("end", draw);

            layout.start();

            function draw(words) {
                d3.select("#wordCloud")
                    .append("svg")
                    .attr("width", layout.size()[0])
                    .attr("height", layout.size()[1])
                    .append("g")
                    .attr("transform", "translate(200,200)")
                    .selectAll("text")
                    .data(words)
                    .enter()
                    .append("text")
                    .style("font-size", d => `${d.size}px`)
                    .style("fill", () => d3.schemeCategory10[Math.floor(Math.random() * 10)])
                    .attr("text-anchor", "middle")
                    .attr
                    .attr("text-anchor", "middle")
                    .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                    .text(d => d.text);
            }
        }

        renderWordCloud(speciesData);

        // Render Mean Population Chart
        function renderMeanPopulationChart(data) {
            const filteredData = data.filter(d => d.population !== "Unknown");
            const meanPopulation = d3.rollup(
                filteredData,
                v => d3.mean(v, d => d.population),
                d => d.type
            );

            const svgWidth = 400;
            const svgHeight = 400;
            const margin = { top: 20, right: 20, bottom: 50, left: 50 };
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            const svg = d3.select("#meanPopulationChart")
                .append("svg")
                .attr("width", svgWidth)
                .attr("height", svgHeight)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .domain([...meanPopulation.keys()])
                .range([0, width])
                .padding(0.4);

            const y = d3.scaleLinear()
                .domain([0, d3.max([...meanPopulation.values()])])
                .nice()
                .range([height, 0]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-40)")
                .style("text-anchor", "end");

            svg.append("g")
                .call(d3.axisLeft(y));

            svg.selectAll(".bar")
                .data([...meanPopulation.entries()])
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d[0]))
                .attr("y", d => y(d[1]))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d[1]))
                .attr("fill", "steelblue");
        }

        renderMeanPopulationChart(speciesData);

        // Render Data Table
        function renderDataTable(data) {
            const table = $('#speciesTable').DataTable({
                data: data,
                columns: [
                    { data: 'name' },
                    { data: 'type' },
                    { data: 'location' },
                    { data: 'population' },
                    { data: 'threats' }
                ],
                pageLength: 5
            });
        }

        renderDataTable(speciesData);

    </script>
</body>

</html>
